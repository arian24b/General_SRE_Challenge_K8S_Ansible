---
- name: Update apt cache
  apt:
    update_cache: yes

- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - conntrack
      - socat
    state: present

- name: Get Kubernetes stable version
  shell: curl -L -s https://dl.k8s.io/release/stable.txt
  register: k8s_version
  changed_when: false

- name: Set Kubernetes version fact
  set_fact:
    kubernetes_version: "{{ k8s_version.stdout }}"

- name: Download kubectl binary
  get_url:
    url: "https://dl.k8s.io/release/{{ kubernetes_version }}/bin/linux/amd64/kubectl"
    dest: /tmp/kubectl
    mode: "0755"

- name: Install kubectl
  copy:
    src: /tmp/kubectl
    dest: /usr/local/bin/kubectl
    mode: "0755"
    remote_src: yes

- name: Download kubeadm binary
  get_url:
    url: "https://dl.k8s.io/release/{{ kubernetes_version }}/bin/linux/amd64/kubeadm"
    dest: /tmp/kubeadm
    mode: "0755"

- name: Install kubeadm
  copy:
    src: /tmp/kubeadm
    dest: /usr/local/bin/kubeadm
    mode: "0755"
    remote_src: yes

- name: Download kubelet binary
  get_url:
    url: "https://dl.k8s.io/release/{{ kubernetes_version }}/bin/linux/amd64/kubelet"
    dest: /tmp/kubelet
    mode: "0755"

- name: Install kubelet
  copy:
    src: /tmp/kubelet
    dest: /usr/local/bin/kubelet
    mode: "0755"
    remote_src: yes

- name: Create kubelet systemd service directory
  file:
    path: /usr/lib/systemd/system/kubelet.service.d
    state: directory
    mode: "0755"

- name: Download kubelet systemd service file
  get_url:
    url: "https://raw.githubusercontent.com/kubernetes/release/v0.16.2/cmd/krel/templates/latest/kubelet/kubelet.service"
    dest: /usr/lib/systemd/system/kubelet.service
    mode: "0644"

- name: Fix kubelet service path
  replace:
    path: /usr/lib/systemd/system/kubelet.service
    regexp: "/usr/bin"
    replace: "/usr/local/bin"

- name: Download kubeadm kubelet config
  get_url:
    url: "https://raw.githubusercontent.com/kubernetes/release/v0.16.2/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf"
    dest: /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
    mode: "0644"

- name: Fix kubeadm config path
  replace:
    path: /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
    regexp: "/usr/bin"
    replace: "/usr/local/bin"

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable kubelet service
  systemd:
    name: kubelet
    enabled: yes

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/kubectl
    - /tmp/kubeadm
    - /tmp/kubelet
