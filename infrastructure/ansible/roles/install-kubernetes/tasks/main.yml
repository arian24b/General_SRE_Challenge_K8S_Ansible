---
# Kubernetes binaries are pre-copied to /tmp by CI/CD pipeline
# because dl.k8s.io is blocked in Iran

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - conntrack
      - socat
    state: present

- name: Check if kubectl binary exists in /tmp
  stat:
    path: /tmp/kubectl
  register: kubectl_binary

- name: Fail if binaries not pre-copied
  fail:
    msg: "Kubernetes binaries must be pre-copied to /tmp by CI/CD pipeline"
  when: not kubectl_binary.stat.exists

- name: Install kubectl
  copy:
    src: /tmp/kubectl
    dest: /usr/local/bin/kubectl
    mode: "0755"
    remote_src: yes

- name: Install kubeadm
  copy:
    src: /tmp/kubeadm
    dest: /usr/local/bin/kubeadm
    mode: "0755"
    remote_src: yes

- name: Install kubelet
  copy:
    src: /tmp/kubelet
    dest: /usr/local/bin/kubelet
    mode: "0755"
    remote_src: yes

- name: Create kubelet systemd service directory
  file:
    path: /usr/lib/systemd/system/kubelet.service.d
    state: directory
    mode: "0755"

- name: Install kubelet systemd service file
  copy:
    src: /tmp/kubelet.service
    dest: /usr/lib/systemd/system/kubelet.service
    mode: "0644"
    remote_src: yes

- name: Fix kubelet service path
  replace:
    path: /usr/lib/systemd/system/kubelet.service
    regexp: "/usr/bin"
    replace: "/usr/local/bin"

- name: Install kubeadm kubelet config
  copy:
    src: /tmp/10-kubeadm.conf
    dest: /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
    mode: "0644"
    remote_src: yes

- name: Fix kubeadm config path
  replace:
    path: /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
    regexp: "/usr/bin"
    replace: "/usr/local/bin"

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable kubelet service
  systemd:
    name: kubelet
    enabled: yes

- name: Clean up temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/kubectl
    - /tmp/kubeadm
    - /tmp/kubelet
    - /tmp/kubelet.service
    - /tmp/10-kubeadm.conf
